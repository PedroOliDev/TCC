<!DOCTYPE html>
<html lang="pt-br">
<head>
  <link rel="stylesheet" href="../static/assinatura.css">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Assinatura com Pagamento</title>
  <style>
    /* Estilos adicionais para o modal de avaliação */
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgb(0,0,0);
      background-color: rgba(0,0,0,0.4);
      padding-top: 60px;
    }
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 10px;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }
    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
    .stars {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }
    .star {
      font-size: 30px;
      color: #ddd;
      cursor: pointer;
      margin: 0 5px;
    }
    .star.selected {
      color: #ffd700;
    }
    .comentario {
      width: 100%;
      height: 80px;
      margin: 10px 0;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .btn-avaliar {
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
    }
    .btn-avaliar:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>
  <img src="../static/imagens/logoTCC.jpg" alt="logo" class="logo">

  <div class="perfil-container" onclick="window.location.href='../templates/perfil.html'">
    <img id="fotoPerfil" alt="Foto de perfil">
  </div>

  <div class="container">
    <form onsubmit="return false;">

      <h1 id="titulo-restaurante">Restaurante</h1>

      <h2>Assinatura Mensal</h2>

      <label>Endereço:</label>
      <input type="text" id="endereco" placeholder="Digite seu endereço" required>

      <label>Dia de entrega:</label>
      <select id="dia">
        <option value="segunda-feira">Segunda-feira</option>
        <option value="terça-feira">Terça-feira</option>
        <option value="quarta-feira">Quarta-feira</option>
        <option value="quinta-feira">Quinta-feira</option>
        <option value="sexta-feira">Sexta-feira</option>
      </select>

      <label>Forma de pagamento:</label>
      <select id="metodo">
        <option value="pix">PIX</option>
        <option value="cartao">Cartão de Crédito</option>
      </select>

      <div class="payment-details" id="detalhes-cartao" style="display: none;">
        <label>Número do cartão:</label>
        <input type="text" id="cc_num" placeholder="0000 0000 0000 0000">

        <label>Validade (MM/AA):</label>
        <input type="text" id="cc_val" placeholder="12/25">

        <label>CVV:</label>
        <input type="text" id="cc_cvv" placeholder="123">
      </div>

      <button type="button" id="btnAssinar">Assinar agora</button>
      <p class="status" id="status"></p>
    </form>
  </div>

  <!-- Modal de Avaliação -->
  <div id="avaliacaoModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal()">&times;</span>
      <h2>Avalie o Restaurante</h2>
      <p>Deixe sua avaliação de 1 a 5 estrelas:</p>
      <div class="stars" id="estrelas">
        <span class="star" data-value="1">&#9733;</span>
        <span class="star" data-value="2">&#9733;</span>
        <span class="star" data-value="3">&#9733;</span>
        <span class="star" data-value="4">&#9733;</span>
        <span class="star" data-value="5">&#9733;</span>
      </div>
      <textarea id="comentario" class="comentario" placeholder="Comentário opcional..."></textarea>
      <button class="btn-avaliar" onclick="enviarAvaliacao()">Enviar Avaliação</button>
    </div>
  </div>

  <script>
    window.onload = async () => {
      const res = await fetch("http://localhost:5000/perfil", {
        credentials: "include"
      });

      if (res.ok) {
        const usuario = await res.json();
        const foto = document.getElementById("fotoPerfil");

        if (usuario.foto_url) {
          foto.src = `http://localhost:5000${usuario.foto_url}`;
        } else {
          foto.src = '../static/imagens/default.png';
        }
      }
    };

    const metodo = document.getElementById('metodo');
    const detalhes = document.getElementById('detalhes-cartao');

    metodo.addEventListener('change', () => {
      detalhes.style.display = metodo.value === 'cartao' ? 'block' : 'none';
    });

    // NOVO: Funções para capturar parâmetros da URL
    function getRestaurantIdFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get("restaurante") || "1";
    }

    function getPlanIdFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get("plano") || "basic";  // Fallback para "basic" se não houver
    }

    function getCategoriaFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get("categoria") || "";  // Fallback vazio se não houver
    }

    // NOVO: Captura os valores da URL
    const restauranteId = getRestaurantIdFromURL();
    const planoId = getPlanIdFromURL();
    const categoria = getCategoriaFromURL();

    // NOVO: Função para obter o title do plano baseado no id (usando restaurantData)
    function getPlanTitle(planId, restaurant) {
      if (restaurant && restaurant.plans) {
        const plan = restaurant.plans.find(p => p.id === planId);
        return plan ? plan.title : "Plano Básico";  // Fallback
      }
      return "Plano Básico";
    }

    // Dados hardcoded (mantidos, mas você pode removê-los se não precisar, pois vêm do backend em planos.html)
    const restaurantData = {
      1: {
        name: "Burger King",
        cuisine: "Fast Food",
        image: "../static/imagens/Lanches.jpg",
        rating: 4.5,
        deliveryTime: "20-30 min",
        deliveryFee: "Grátis",
        plans: [
          {
            id: "basic",
            title: "Plano Básico",
            description: "Ideal para quem quer experimentar nossos sabores",
            price: "R$ 19,90",
            period: "/mês",
            features: [
              "Lanches até R$ 20,00",
              "Entrega grátis",
              "Lanches Novos todo Mes",
              "Suporte prioritário",
            ],
          },
          {
            id: "premium",
            title: "Plano Premium",
            description: "Para os verdadeiros amantes de hambúrguer",
            price: "R$ 39,90",
            period: "/mês",
            popular: true,
            features: [
              "Lanches acima de R$ 30,00",
              "Entrega grátis",
              "Acesso antecipado a novos produtos",
              "Brinde mensal exclusivo",
              "Suporte VIP 24/7",
            ],
          },
          {
            id: "family",
            title: "Plano Família",
            description: "Perfeito para compartilhar com toda a família",
            price: "R$ 59,90",
            period: "/mês",
            features: [
              "Lanches acima de R$ 40,00 para até 4 pessoas ",
              "Entrega grátis",
              "Válido para até 4 pessoas",
              "Combos familiares exclusivos",
              "Festa de aniversário grátis",
            ],
          },
        ],
      },
      2: {
        name: "McDonald's",
        cuisine: "Fast Food",
        image: "../static/imagens/Mc.png",
        rating: 4.3,
        deliveryTime: "25-35 min",
        deliveryFee: "R$ 3,99",
        plans: [
          {
            id: "basic",
            title: "McPlano Básico",
            description: "Comece sua jornada McDonald's",
            price: "R$ 24,90",
            period: "/mês",
            features: [
              "Lanches de até R$ 25,00",
              "Entrega grátis em pedidos acima de R$ 30",
              "Acesso ao app exclusivo",
              "Pontos em dobro no programa de fidelidade",
            ],
          },
          {
            id: "premium",
            title: "McPlano Premium",
            description: "A experiência completa McDonald's",
            price: "R$ 44,90",
            period: "/mês",
            popular: true,
            features: [
              "Pedidos acima de R$ 35,00",
              "Entrega grátis",
              "Acesso antecipado a novos produtos",
              "Happy Meal grátis no aniversário",
              "Atendimento prioritário",
            ],
          },
        ],
      },
      5: {
        name: "Domino's Pizza",
        cuisine: "Pizzaria",
        image: "fresh-pizza-margherita-with-basil.jpg",
        rating: 4.6,
        deliveryTime: "25-35 min",
        deliveryFee: "Grátis",
        plans: [
          {
            id: "basic",
            title: "Pizza Lover",
            description: "Para os amantes de pizza",
            price: "R$ 29,90",
            period: "/mês",
            features: [
              "20% de desconto em pizzas",
              "Entrega grátis em pedidos acima de R$ 40",
              "Pizza grátis no seu aniversário",
              "Acesso a sabores exclusivos",
            ],
          },
          {
            id: "premium",
            title: "Pizza Master",
            description: "A experiência definitiva em pizzas",
            price: "R$ 49,90",
            period: "/mês",
            popular: true,
            features: [
              "30% de desconto em todas as pizzas",
              "Entrega grátis ilimitada",
              "2 pizzas grátis por mês",
              "Acesso antecipado a novos sabores",
              "Personalização exclusiva de pizzas",
            ],
          },
        ],
      },
      6: {
        name: "Pizza Hut",
        cuisine: "Pizzaria",
        image: "fresh-pizza-margherita-with-basil.jpg",
        rating: 4.6,
        deliveryTime: "25-35 min",
        deliveryFee: "Grátis",
        plans: [
          {
            id: "basic",
            title: "Pizza Lover",
            description: "Para os amantes de pizza",
            price: "R$ 29,90",
            period: "/mês",
            features: [
              "20% de desconto em pizzas",
              "Entrega grátis em pedidos acima de R$ 40",
              "Pizza grátis no seu aniversário",
              "Acesso a sabores exclusivos",
            ],
          },
          {
            id: "premium",
            title: "Pizza Master",
            description: "A experiência definitiva em pizzas",
            price: "R$ 49,90",
            period: "/mês",
            popular: true,
            features: [
              "30% de desconto em todas as pizzas",
              "Entrega grátis ilimitada",
              "2 pizzas grátis por mês",
              "Acesso antecipado a novos sabores",
              "Personalização exclusiva de pizzas",
            ],
          },
        ],
      },
    };

    const restaurant = restaurantData[restauranteId];
    const titulo = document.getElementById("titulo-restaurante");

    if (restaurant) {
      
      const planTitle = getPlanTitle(planoId, restaurant);
      titulo.innerText = `${restaurant.name} - ${planTitle}`;
    } else {
      titulo.innerText = "Restaurante não encontrado";
    }

    // Variáveis para avaliação
    let estrelasSelecionadas = 0;

    // Adicionar event listeners para estrelas
    document.querySelectorAll('.star').forEach(star => {
      star.addEventListener('click', () => {
        estrelasSelecionadas = parseInt(star.dataset.value);
        atualizarEstrelas(estrelasSelecionadas);
      });
    });

    function atualizarEstrelas(num) {
      document.querySelectorAll('.star').forEach((star, index) => {
        if (index < num) {
          star.classList.add('selected');
        } else {
          star.classList.remove('selected');
        }
      });
    }

    function mostrarModal() {
      document.getElementById('avaliacaoModal').style.display = 'block';
    }

    function fecharModal() {
      document.getElementById('avaliacaoModal').style.display = 'none';
      estrelasSelecionadas = 0;
      atualizarEstrelas(0);
      document.getElementById('comentario').value = '';
    }

    function enviarAvaliacao() {
      if (estrelasSelecionadas < 1 || estrelasSelecionadas > 5) {
        alert('Selecione de 1 a 5 estrelas.');
        return;
      }
      const comentario = document.getElementById('comentario').value;
      avaliarRestaurante(restauranteId, estrelasSelecionadas, comentario);
      fecharModal();
      alert('Avaliação enviada! Obrigado.');
    }

    document.getElementById('btnAssinar').addEventListener('click', () => {
      const btn = document.getElementById('btnAssinar');
      const status = document.getElementById('status');
      btn.disabled = true;
      status.textContent = 'Processando...';

      const payload = {
        endereco: document.getElementById('endereco').value.trim(),
        dia: document.getElementById('dia').value,
        metodo: document.getElementById('metodo').value,
        plano: planoId,  
        categoria: categoria  
      };

      if (metodo.value === 'cartao') {
        payload.cc = {
          numero: document.getElementById('cc_num').value.trim(),
          validade: document.getElementById('cc_val').value.trim(),
          cvv: document.getElementById('cc_cvv').value.trim()
        };
      } else if (metodo.value === 'pix') {
        baixarPDF();
      }

      fetch('http://localhost:5000/assinatura', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        credentials: 'include'
      })
      .then(res => res.json().then(body => ({ status: res.status, body })))
      .then(({ status: st, body }) => {
        status.style.color = st === 200 ? 'green' : 'red';
        status.textContent = body.message || 'Erro';
        if (st === 200) {
          // Após sucesso, mostrar modal de avaliação
          setTimeout(() => mostrarModal(), 1000);  // Pequeno delay para o usuário ver a mensagem
        }
      })
      .catch(() => {
        status.style.color = 'red';
        status.textContent = 'Erro de conexão';
      })
      .finally(() => btn.disabled = false);
    });

    function baixarPDF() {
      const link = document.createElement('a');
      link.href = '../templates/pagamento_pdf.pdf'; 
      link.download = 'PagamentoPIX.pdf';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function avaliarRestaurante(restauranteId, estrelas, comentario = '') {
      fetch('http://localhost:5000/avaliar', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'include',  
        body: JSON.stringify({
          restaurante_id: restauranteId,
          estrelas: estrelas,
          comentario: comentario
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.message) {
          console.log(data.message);
        }
      })
      .catch(error => console.error('Erro:', error));
    }

    function carregarAvaliacoes(restauranteId) {
      fetch(`http://localhost:5000/avaliacoes/${restauranteId}`, {
        credentials: 'include'
      })
      .then(response => response.json())
      .then(avaliacoes => {
        console.log(avaliacoes);
      })
      .catch(error => console.error('Erro:', error));
    }
  </script>
</body>
</html>