<!DOCTYPE html>
<html lang="pt-br">
<head>
  <link rel="stylesheet" href="../static/assinatura.css">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Assinatura com Pagamento</title>

  <style>
    /* Estilos adicionais para o modal de avaliação */
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgb(0,0,0);
      background-color: rgba(0,0,0,0.4);
      padding-top: 60px;
      
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 10px;
      color: black;
      
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }
    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
    .stars {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }
    .star {
      font-size: 30px;
      color: #ddd;
      cursor: pointer;
      margin: 0 5px;
    }
    .star.selected {
      color: #ffd700;
    }
    .comentario {
      width: 100%;
      height: 80px;
      margin: 10px 0;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .btn-avaliar {
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
    }
    .btn-avaliar:hover {
      background-color: #45a049;
    }
    .btn-confirmar-pix {
      background-color: #007bff;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
    }
    .btn-confirmar-pix:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
<a href="../templates/menu.html">
    <img src="../static/imagens/logoTCC.jpg"  alt="logo" class="logo">
    </a>

  <div class="perfil-container" onclick="window.location.href='../templates/perfil.html'">
    <img id="fotoPerfil" alt="Foto de perfil">
  </div>

  <div class="container">
    <form onsubmit="return false;">

      <h1 id="titulo-restaurante">Carregando...</h1>

      <h2>Assinatura Mensal</h2>

      <label>Endereço:</label>
      <input type="text" id="endereco" placeholder="Digite seu endereço" required>

      <label>Dia de entrega:</label>
      <select id="dia">
        <option value="segunda-feira">Segunda-feira</option>
        <option value="terça-feira">Terça-feira</option>
        <option value="quarta-feira">Quarta-feira</option>
        <option value="quinta-feira">Quinta-feira</option>
        <option value="sexta-feira">Sexta-feira</option>
      </select>

      <label>Forma de pagamento:</label>
      <select id="metodo">
        <option value="pix">PIX</option>
        <option value="cartao">Cartão de Crédito</option>
      </select>

      <div class="payment-details" id="detalhes-cartao" style="display: none;">
        <label>Número do cartão:</label>
        <input type="text" id="cc_num" placeholder="0000 0000 0000 0000">

        <label>Validade:</label>
        <input type="text" id="cc_val" placeholder="12/25">

        <label>CVV:</label>
        <input type="text" id="cc_cvv" placeholder="123">
      </div>

      <button type="button" id="btnAssinar">Assinar agora</button>
      <p class="status" id="status"></p>
    </form>
  </div>

  
  <div id="avaliacaoModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal()">&times;</span>
      <h2>Avalie o Restaurante</h2>
      <p>De 1 a 5 estrelas:</p>

      <div class="stars" id="estrelas">
        <span class="star" data-value="1">&#9733;</span>
        <span class="star" data-value="2">&#9733;</span>
        <span class="star" data-value="3">&#9733;</span>
        <span class="star" data-value="4">&#9733;</span>
        <span class="star" data-value="5">&#9733;</span>
      </div> 

      <textarea id="comentario" placeholder="Comentário (opcional)" class="comentario"></textarea>
      <button onclick="enviarAvaliacao()" class="btn-avaliar">Enviar Avaliação</button>
    </div>
  </div>

  <!-- Novo modal para PIX -->
  <div id="pixModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharPixModal()">&times;</span>
      <h2>Pagamento via PIX</h2>
      <p>Use a chave PIX abaixo para realizar o pagamento:</p>
      <p id="chavePix" style="font-weight: bold; font-size: 18px; text-align: center; margin: 20px 0;"></p>
      <button onclick="confirmarPix()" class="btn-confirmar-pix">Confirmar Pagamento</button>
    </div>
  </div>

<script>

window.onload = async () => {
  const res = await fetch("http://localhost:5000/perfil", { credentials: "include" });

  if (res.ok) {
    const usuario = await res.json();
    const foto = document.getElementById("fotoPerfil");

    foto.src = usuario.foto_url
      ? `http://localhost:5000${usuario.foto_url}`
      : '../static/imagens/default.png';
  }
};

// Mostrar ou ocultar cartão
document.getElementById('metodo').addEventListener('change', () => {
  document.getElementById('detalhes-cartao').style.display =
    document.getElementById('metodo').value === 'cartao' ? 'block' : 'none';
});

// ------------------------------
// Pegar parâmetros da URL
// ------------------------------
function param(nome) {
  return new URLSearchParams(window.location.search).get(nome);
}

const restauranteId = param("restaurante");
const planoId = param("plano") || "basic";
const categoria = param("categoria") || "";

// ------------------------------
// Buscar restaurante no backend
// ------------------------------
async function fetchRestaurantData(id) {
  const resp = await fetch(`http://localhost:5000/restaurante/${id}`, {
    credentials: "include"
  });

  return resp.ok ? resp.json() : null;
}

(async () => {
  if (!restauranteId) {
    document.getElementById("titulo-restaurante").innerText =
      "Erro: restaurante não informado";
    return;
  }

  const restaurant = await fetchRestaurantData(restauranteId);

  if (!restaurant) {
    document.getElementById("titulo-restaurante").innerText =
      "Restaurante não encontrado";
    return;
  }

  const plan = restaurant.plans.find(p => p.id === planoId);
  const planTitle = plan ? plan.title : "Plano Básico";

  document.getElementById("titulo-restaurante").innerText =
    `${restaurant.name} - ${planTitle}`;
})();

// ------------------------------
// Envio da assinatura
// ------------------------------
document.getElementById('btnAssinar').addEventListener('click', () => {

  const status = document.getElementById("status");

  const payload = {
    endereco: document.getElementById('endereco').value.trim(),
    dia: document.getElementById('dia').value,
    metodo: document.getElementById('metodo').value,
    plano: planoId,
    categoria: categoria,
    restaurante_id: restauranteId
  };

  if (!payload.endereco) {
    status.style.color = "red";
    status.textContent = "Digite o endereço!";
    return;
  }

  if (payload.metodo === "cartao") {
    payload.cc = {
      numero: document.getElementById('cc_num').value.trim(),
      validade: document.getElementById('cc_val').value.trim(),
      cvv: document.getElementById('cc_cvv').value.trim()
    };
  }

  fetch("http://localhost:5000/assinatura", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify(payload)
  })
  .then(r => r.json().then(body => ({status: r.status, body})))
  .then(({status, body}) => {

    statusText = document.getElementById("status");
    statusText.style.color = status === 200 ? "green" : "red";
    statusText.textContent = body.message;

    if (status === 200) {
      if (payload.metodo === 'pix') {
        // Assumindo que o backend retorna a chave PIX em body.chave_pix
        document.getElementById('chavePix').textContent = body.chave_pix || '8fb034d2-de4a-4192-9c91-d6ea710634a2'; // Fallback se não vier
        document.getElementById('pixModal').style.display = 'block';
      } else {
        setTimeout(() => mostrarModal(), 800);
      }
    }
  })
  .catch(() => {
    status.style.color = "red";
    status.textContent = "Erro de conexão.";
  });
});


// ------------------------------
// Avaliação
// ------------------------------
let estrelasSelecionadas = 0;

document.querySelectorAll('.star').forEach(star => {
  star.addEventListener('click', () => {
    estrelasSelecionadas = parseInt(star.dataset.value);
    atualizarEstrelas(estrelasSelecionadas);
  });
});

function atualizarEstrelas(num) {
  document.querySelectorAll('.star').forEach((s, i) => {
    s.classList.toggle('selected', i < num);
  });
}

function mostrarModal() {
  document.getElementById("avaliacaoModal").style.display = "block";
}

function fecharModal() {
  document.getElementById("avaliacaoModal").style.display = "none";
  estrelasSelecionadas = 0;
  atualizarEstrelas(0);
  document.getElementById("comentario").value = "";
}

function enviarAvaliacao() {

  fetch("http://localhost:5000/avaliar", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    credentials: "include",
    body: JSON.stringify({
      restaurante_id: restauranteId,
      estrelas: estrelasSelecionadas,
      comentario: document.getElementById("comentario").value
    })
  });

  fecharModal();
  alert("Avaliação enviada!");
}

// ------------------------------
// Funções para o modal PIX
// ------------------------------
function fecharPixModal() {
  document.getElementById('pixModal').style.display = 'none';
}

function confirmarPix() {
  // Aqui você pode adicionar lógica para confirmar o pagamento, como enviar uma requisição ao backend
  // Por exemplo, fetch para confirmar o pagamento
  fecharPixModal();
  alert("Pagamento confirmado! Agora avalie o restaurante.");
  setTimeout(() => mostrarModal(), 500); // Mostra o modal de avaliação após confirmar
}

</script>
</body>
</html>
