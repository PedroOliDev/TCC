<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="../static/perfil.css" />
  <title>Perfil do Usu√°rio</title>
  
</head>
<body>

  <div class="perfil-container">
    <h2>Seu Perfil</h2>

    <img src="" alt="Foto de perfil" class="foto-preview" id="fotoPreview" />

    <input type="file" id="foto" accept="image/*" />
    
    <input type="text" id="nome" placeholder="Nome completo" />
    <input type="email" id="email" placeholder="Email" disabled />
    <input type="password" id="senha" placeholder="Nova senha" />

    <!-- Hist√≥rico de Assinaturas -->
    <section class="historico-assinaturas">
      <h3>Hist√≥rico de Assinaturas</h3>
      <ul id="lista-historico">
        <li>Carregando...</li>
      </ul>
    </section>

    <!-- Assinaturas Mais Consumidas -->
    <section class="assinaturas-mais-consumidas">
      <h3>Assinaturas Mais Consumidas</h3>
      <ul id="lista-mais-consumidas">
        <li>Carregando...</li>
      </ul>
    </section>

    <button onclick="salvarPerfil()">Salvar Altera√ß√µes</button>
  </div>

  <div id="adminSection" style="display: none; margin-top: 20px; text-align: center;">
    <h3>√Årea Administrativa</h3>
    <button onclick="window.location.href='http://localhost:5000/admin'" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
        Gerenciar Restaurantes e Clientes
    </button>
</div>

  <script>
    const baseURL = "http://localhost:5000";

    // Fun√ß√£o para verificar se o usu√°rio √© admin
    async function checkAdminStatus() {
        try {
            const res = await fetch('http://localhost:5000/check_admin', {
                credentials: 'include',  // Inclui cookies/sess√£o
                mode: 'cors'
            });
            if (res.ok) {
                const data = await res.json();
                if (data.is_admin) {
                    document.getElementById('adminSection').style.display = 'block';  // Mostra o bot√£o
                }
            }
        } catch (error) {
            console.error('Erro ao verificar status de admin:', error);
        }
    }


    // ‚ú® Anima√ß√£o de estrelas
    const starsContainer = document.createElement('div');
    starsContainer.classList.add('stars');
    document.body.appendChild(starsContainer);

    for (let i = 0; i < 200; i++) {
      const star = document.createElement('div');
      star.classList.add('star');
      star.style.top = `${Math.random() * 100}%`;
      star.style.left = `${Math.random() * 100}%`;
      star.style.width = `${Math.random() * 2 + 1}px`;
      star.style.height = star.style.width;
      star.style.animationDuration = `${2 + Math.random() * 3}s`;
      star.style.animationDelay = `${Math.random() * 2}s`;
      starsContainer.appendChild(star);
    }

    // üîÑ Carrega perfil e dados de assinaturas
    window.onload = () => {
      // Carrega perfil
      fetch(`${baseURL}/perfil`, {
        method: "GET",
        credentials: "include"
      })
      .then(res => {
        if (res.status === 401) {
          alert("Voc√™ precisa estar logado.");
          window.location.href = `${baseURL}/login.html`;
          return;
        }
        return res.json();
      })
      .then(usuario => {
        if (!usuario) return;
        document.getElementById('nome').value = usuario.nome || '';
        document.getElementById('email').value = usuario.email || '';

        const fotoPreview = document.getElementById('fotoPreview');
        if (usuario.foto_url) {
          fotoPreview.src = baseURL + usuario.foto_url;
        } else {
          fotoPreview.src = baseURL + '/static/imagens/default.png';
        }
      })
      .catch(err => {
        console.error("Erro ao carregar perfil:", err);
        document.getElementById('lista-historico').innerHTML = '<li>Erro ao carregar.</li>';
      });

      // Carrega hist√≥rico de assinaturas
      fetch(`${baseURL}/historico-assinaturas`, {
        method: "GET",
        credentials: "include"
      })
      .then(res => {
        if (res.status === 401) {
          window.location.href = `${baseURL}/login.html`;
          return;
        }
        return res.json();
      })
      .then(historico => {
        const lista = document.getElementById('lista-historico');
        if (historico && historico.length > 0) {
          lista.innerHTML = historico.map(item => 
            `<li><strong>${item.plano}</strong> ‚Äì ${item.status} em ${new Date(item.data).toLocaleDateString('pt-BR')}</li>`
          ).join('');
        } else {
          lista.innerHTML = '<li>Nenhum hist√≥rico encontrado.</li>';
        }
      })
      .catch(err => {
        console.error("Erro ao carregar hist√≥rico:", err);
        document.getElementById('lista-historico').innerHTML = '<li>Erro ao carregar hist√≥rico.</li>';
      });

      // Carrega assinaturas mais consumidas
      fetch(`${baseURL}/assinaturas-mais-consumidas`, {
        method: "GET",
        credentials: "include"
      })
      .then(res => {
        if (res.status === 401) {
          window.location.href = `${baseURL}/login.html`;
          return;
        }
        return res.json();
      })
      .then(maisConsumidas => {
        const lista = document.getElementById('lista-mais-consumidas');
        if (maisConsumidas && maisConsumidas.length > 0) {
          lista.innerHTML = maisConsumidas.map(item => 
            `<li>${item.plano} ‚Äì ${item.dias} dias utilizados</li>`
          ).join('');
        } else {
          lista.innerHTML = '<li>Nenhuma assinatura registrada.</li>';
        }
      })
      .catch(err => {
        console.error("Erro ao carregar assinaturas mais consumidas:", err);
        document.getElementById('lista-mais-consumidas').innerHTML = '<li>Erro ao carregar dados.</li>';
      });
    };

    // üíæ Salvar perfil
    function salvarPerfil() {
      const nome = document.getElementById('nome').value.trim();
      const senha = document.getElementById('senha').value;
      const foto = document.getElementById('foto').files[0];

      if (!nome) {
        alert("Por favor, preencha o nome.");
        return;
      }

      const formData = new FormData();
      formData.append('nome', nome);
      if (senha) formData.append('senha', senha);
      if (foto) formData.append('foto', foto);

      fetch(`${baseURL}/atualizar-perfil`, {
        method: "POST",
        body: formData,
        credentials: "include"
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message || "Perfil atualizado com sucesso!");
        if (data.success) {
          location.reload();
        }
      })
      .catch(err => {
        console.error("Erro ao salvar:", err);
        alert("Ocorreu um erro ao salvar as altera√ß√µes.");
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
        checkAdminStatus();
        
    });
  </script>
</body>
</html>